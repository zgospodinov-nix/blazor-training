@page "/todos"
@using Domain
@using TodoApp.Data

<PageTitle>Todos</PageTitle>

<h1 class="d-flex align-items-center">
    Todos
    <button class="btn btn-sm btn-primary ms-3" @onclick="() => ShowAddModal = true">Add</button>
</h1>

<div class="my-3">
    <InputText class="form-control w-50" placeholder="Filter todos..." @bind-Value="SearchTerm" @oninput="FilterIncompleted" />
</div>

<TodoAddModal IsVisible="ShowAddModal" IsVisibleChanged="@(v => ShowAddModal = v)" />
<TodoEditModal IsVisible="ShowEditModal" IsVisibleChanged="@(v => ShowEditModal = v)" Model="SelectedForEdit" />

@if (!string.IsNullOrEmpty(StatusMessage))
{
    <div class="alert alert-info">@StatusMessage</div>
}

<table class="table table-striped">
    <thead>
        <tr>
            <th></th>
            <th>Title</th>
            <th>Description</th>
            <th>Due</th>
            <th>Created</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var todo in FilteredTodos)
        {
            <tr>
                <td>
                    <input type="checkbox" checked="@todo.IsCompleted" @onclick="() => ToggleCompleted(todo.Id)" />
                </td>
                <td>@todo.Title</td>
                <td>@(string.IsNullOrWhiteSpace(todo.Description) ? "-" : todo.Description)</td>
                <td>@(todo.DueDate?.ToString("yyyy-MM-dd") ?? "-")</td>
                <td>@todo.CreatedDate.ToString("yyyy-MM-dd")</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => EditTodo(todo.Id)">Edit</button>
                    <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTodo(todo.Id)">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<h3>Completed</h3>
<table class="table table-sm">
    <thead>
        <tr>
            <th>Title</th>
            <th>Completed Date</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var c in InMemoryTodoStore.GetCompleted())
        {
            <tr>
                <td>@c.Title</td>
                <td>@c.CreatedDate.ToString("yyyy-MM-dd")</td>
            </tr>
        }
    </tbody>
</table>

@code {
    private bool ShowAddModal;
    private bool ShowEditModal;
    private Todo? SelectedForEdit;
    private string? StatusMessage;

    private string SearchTerm { get; set; } = string.Empty;

    private IEnumerable<Todo> FilteredTodos { get; set; } = InMemoryTodoStore.GetAll();

    private void FilterIncompleted(ChangeEventArgs args)
    {
        SearchTerm = args.Value?.ToString() ?? string.Empty;
        FilteredTodos = string.IsNullOrWhiteSpace(SearchTerm)
            ? InMemoryTodoStore.GetAll()
            : InMemoryTodoStore.GetAll().Where(t =>
                (t.Title?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (t.Description?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ?? false));
    }

    protected override void OnInitialized()
    {
        // Nothing - using static store
    }

    private void EditTodo(Guid id)
    {
        SelectedForEdit = InMemoryTodoStore.GetById(id);
        if (SelectedForEdit != null)
        {
            ShowEditModal = true;
        }
        else
        {
            StatusMessage = "Not found";
        }
    }

    private void DeleteTodo(Guid id)
    {
        var removed = InMemoryTodoStore.Remove(id);
        StatusMessage = removed ? "Deleted" : "Not found";
    }

    private void ToggleCompleted(Guid id)
    {
        var success = InMemoryTodoStore.MarkCompleted(id);
        StatusMessage = success ? "Marked as completed" : "Not found";
    }
}
